<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Vliegtuig herrie boven Arnhem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --card-bg: #f6f6f6;
      --border: #cccccc;
      --accent: #2563eb;
    }
    body.dark {
      --bg: #0f172a;
      --fg: #e5e7eb;
      --card-bg: #111827;
      --border: #374151;
      --accent: #60a5fa;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1100px;
      margin: auto;
      padding: 1.5rem;
      background: var(--bg);
      color: var(--fg);
      transition: background 0.2s, color 0.2s;
    }
    a { color: var(--accent); }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.7rem;
      margin: 0;
    }

    .toggle {
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 0.75rem;
      padding: 0.9rem 1rem;
      border: 1px solid var(--border);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 0.35rem 0.4rem;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }

    #last10-table {
      max-height: 280px;
      overflow-y: auto;
      margin-top: 0.5rem;
    }

    /* Heatmap */
    #heatmap {
      display: grid;
      grid-template-columns: 60px repeat(24, 1fr);
      gap: 1px;
      font-size: 0.7rem;
    }
    .heat-header {
      text-align: center;
      padding: 0.1rem;
    }
    .heat-cell {
      text-align: center;
      padding: 0.15rem;
      cursor: default;
      color: #f9fafb;
    }
    .heat-label {
      padding: 0.2rem 0.3rem;
    }

    /* Map */
    #map {
      width: 100%;
      height: 330px;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      margin-top: 0.5rem;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 600;
    }
    .stat-label {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    @media (max-width: 600px) {
      body { padding: 1rem; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Vliegtuigen boven Arnhem</h1>
    <p style="margin:0.2rem 0 0;">
      Gegevens afkomstig van
      <a href="https://adsb.fi" target="_blank" rel="noreferrer">adsb.fi open data</a>.
      Persoonlijk &amp; niet-commercieel gebruik.
    </p>
  </div>
  <button id="darkToggle" class="toggle">ðŸŒ™ Donkere modus</button>
</header>

<div class="grid" style="margin-bottom:1rem;">
  <div class="card">
    <h2>Overzicht</h2>
    <div class="grid">
      <div>
        <div class="stat-value" id="stat-total">â€“</div>
        <div class="stat-label">Totaal vluchten</div>
      </div>
      <div>
        <div class="stat-value" id="stat-median">â€“</div>
        <div class="stat-label">Mediaan per dag</div>
      </div>
      <div>
        <div class="stat-value" id="stat-busiest">â€“</div>
        <div class="stat-label">Drukste dag</div>
      </div>
    </div>
    <p style="margin-top:0.6rem; font-size:0.8rem;">
      Periode: <span id="stat-range">â€“</span>
    </p>
  </div>

  <div class="card">
    <h2>Top 10 callsigns</h2>
    <div style="max-height:180px; overflow-y:auto;">
      <table id="topcallsigns">
        <thead>
          <tr>
            <th>Callsign</th>
            <th>Aantal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="grid" style="margin-bottom:1rem;">
  <div class="card">
    <h2>Laatste 10 vliegtuigen</h2>
    <div id="last10-table">
      <table>
        <thead>
          <tr>
            <th>Tijd (UTC)</th>
            <th>Callsign</th>
            <th>Snelheid (km/h)</th>
            <th>Hoogte (km)</th>
          </tr>
        </thead>
        <tbody id="last10-body"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Aantal vluchten per dag</h2>
    <canvas id="dailyChart" height="180"></canvas>
  </div>
</div>

<div class="grid" style="margin-bottom:1rem;">
  <div class="card">
    <h2>Drukte per uur (gemiddeld)</h2>
    <div id="heatmap"></div>
  </div>
  <div class="card">
    <h2>Laatste vliegroutes</h2>
    <div id="map"></div>
  </div>
</div>

<p style="font-size:0.75rem; opacity:0.7; margin-top:1.5rem;">
  Deze pagina gebruikt open data van adsb.fi en een straal van ongeveer 5 km rond het centrum van Arnhem.
</p>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7kGStG3dnG18su1mD0C6hiwqvZ6V1lP6RKz0+w="
  crossorigin=""
></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// ========= CONFIG =========
const BACKEND = "https://arnhem-flights-api.onrender.com";

// ========= HELPERS =========
function kts_to_kmh(kts) {
  return kts ? (kts * 1.852).toFixed(1) : "";
}
function ft_to_km(ft) {
  return ft ? (ft * 0.0003048).toFixed(2) : "";
}
function fmtDate(iso) {
  if (!iso) return "â€“";
  return iso.slice(0, 10);
}

// ========= DARK MODE =========
const darkToggle = document.getElementById("darkToggle");
const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
if (prefersDark) document.body.classList.add("dark");

darkToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
});

// ========= LAST 10 =========
async function loadLast10() {
  try {
    const r = await fetch(`${BACKEND}/api/last10`);
    const data = await r.json();
    const tbody = document.getElementById("last10-body");
    tbody.innerHTML = "";
    for (const row of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.ts}</td>
        <td>${row.callsign || ""}</td>
        <td>${kts_to_kmh(row.gs_kts)}</td>
        <td>${ft_to_km(row.alt_ft)}</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) {
    console.error("last10 error:", e);
  }
}

// ========= STATS =========
async function loadStats() {
  try {
    const r = await fetch(`${BACKEND}/api/stats`);
    const s = await r.json();
    document.getElementById("stat-total").textContent = s.total_flights ?? "0";

    let med = s.median_per_day || 0;
    document.getElementById("stat-median").textContent =
      typeof med === "number" ? med.toFixed(1) : med;

    const busiest = s.max_per_day && s.max_per_day_date
      ? `${s.max_per_day} (${s.max_per_day_date})`
      : "â€“";
    document.getElementById("stat-busiest").textContent = busiest;

    const range = `${fmtDate(s.first_ts)} â€“ ${fmtDate(s.last_ts)}`;
    document.getElementById("stat-range").textContent = range;
  } catch (e) {
    console.error("stats error:", e);
  }
}

// ========= DAILY CHART =========
let dailyChart;
async function loadDailyChart() {
  try {
    const r = await fetch(`${BACKEND}/api/daily_counts`);
    const data = await r.json();
    const labels = data.map(d => d.day);
    const values = data.map(d => d.flights);

    const ctx = document.getElementById("dailyChart");
    if (dailyChart) dailyChart.destroy();
    dailyChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "vluchten per dag",
          data: values
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 45, minRotation: 45 } },
          y: { beginAtZero: true }
        }
      }
    });
  } catch (e) {
    console.error("daily chart error:", e);
  }
}

// ========= TOP CALLSIGNS =========
async function loadTopCallsigns() {
  try {
    const r = await fetch(`${BACKEND}/api/top_callsigns`);
    const data = await r.json();
    const tbody = document.querySelector("#topcallsigns tbody");
    tbody.innerHTML = "";
    for (const row of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.callsign}</td>
        <td>${row.flights}</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) {
    console.error("top callsigns error:", e);
  }
}

// ========= HOURLY HEATMAP =========
async function loadHeatmap() {
  try {
    const r = await fetch(`${BACKEND}/api/hourly_heatmap`);
    const data = await r.json();

    const grid = Array.from({ length: 7 }, () => Array(24).fill(0));
    let max = 0;
    for (const row of data) {
      const dow = row.dow;
      const hour = row.hour;
      const flights = row.flights;
      grid[dow][hour] = flights;
      if (flights > max) max = flights;
    }

    const weekdayNames = ["Zo", "Ma", "Di", "Wo", "Do", "Vr", "Za"];
    const heatDiv = document.getElementById("heatmap");
    heatDiv.innerHTML = "";

    // header row
    heatDiv.appendChild(document.createElement("div"));
    for (let h = 0; h < 24; h++) {
      const d = document.createElement("div");
      d.className = "heat-header";
      d.textContent = h.toString().padStart(2, "0");
      heatDiv.appendChild(d);
    }

    // rows
    for (let dow = 0; dow < 7; dow++) {
      const label = document.createElement("div");
      label.className = "heat-label";
      label.textContent = weekdayNames[dow];
      heatDiv.appendChild(label);

      for (let h = 0; h < 24; h++) {
        const v = grid[dow][h];
        const cell = document.createElement("div");
        cell.className = "heat-cell";
        if (max > 0 && v > 0) {
          const t = v / max;
          const rC = 8 + Math.round((56 - 8) * t);
          const gC = 48 + Math.round((152 - 48) * t);
          const bC = 107 + Math.round((255 - 107) * t);
          cell.style.backgroundColor = `rgb(${rC},${gC},${bC})`;
        } else {
          cell.style.backgroundColor = "transparent";
          cell.style.color = "inherit";
        }
        cell.title = `${weekdayNames[dow]} ${h}:00 â€“ ${v} vluchten`;
        cell.textContent = v ? v : "";
        heatDiv.appendChild(cell);
      }
    }
  } catch (e) {
    console.error("heatmap error:", e);
  }
}

// ========= TRACKS MAP =========
let map;
let trackLayers = [];

function initMap() {
  map = L.map("map").setView([51.9851, 5.8987], 9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap-bijdragers"
  }).addTo(map);
}

function clearTracks() {
  for (const l of trackLayers) l.remove();
  trackLayers = [];
}

async function loadTracks() {
  try {
    if (!map) initMap();
    const r = await fetch(`${BACKEND}/api/tracks`);
    const data = await r.json();
    clearTracks();

    const colors = ["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899",
                    "#14b8a6","#f97316","#06b6d4","#4b5563"];

    let bounds = [];
    data.forEach((track, idx) => {
      const pts = track.points
        .filter(p => p.lat != null && p.lon != null)
        .map(p => [p.lat, p.lon]);
      if (pts.length < 2) return;
      const color = colors[idx % colors.length];
      const poly = L.polyline(pts, { color, weight: 2 });
      poly.addTo(map).bindPopup(`${track.callsign}`);
      trackLayers.push(poly);
      bounds = bounds.concat(pts);
    });

    if (bounds.length) {
      map.fitBounds(bounds, { padding: [20,20] });
    }
  } catch (e) {
    console.error("tracks error:", e);
  }
}

// ========= INIT =========
loadLast10();
loadStats();
loadDailyChart();
loadTopCallsigns();
loadHeatmap();
loadTracks();

// periodic refreshes
setInterval(loadLast10, 60000);
setInterval(loadTracks, 120000);
setInterval(loadDailyChart, 300000);
setInterval(loadTopCallsigns, 300000);
</script>

</body>
</html>
