<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Vliegtuigen boven Arnhem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&family=Roboto+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Source Serif Pro", serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem 3rem;
      line-height: 1.6;
      color: #222;
      background: #fafafa;
    }

    h1, h2, h3 {
      font-weight: 600;
      margin-top: 2.2rem;
      margin-bottom: 1rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.6rem;
      font-family: "Roboto Mono", monospace;
      background: #fff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.5rem;
    }

    th {
      background: #f3f3f3;
      font-weight: 600;
    }

    .section {
      margin-top: 2rem;
      margin-bottom: 2.5rem;
      border-top: 1px solid #ddd;
      padding-top: 1.2rem;
    }

    #map {
      width: 100%;
      height: 350px;
      border: 1px solid #ccc;
      margin-top: 0.7rem;
    }

    /* Heatmap grid */
    #heatmap {
      margin-top: 0.7rem;
      font-size: 0.8rem;
      transform: scale(1.25);
      transform-origin: left top;
    }

    .heat-row {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .heat-label {
      width: 26px;
      text-align: right;
      margin-right: 4px;
      color: #555;
    }
    .heat-cell {
      width: 16px;
      height: 16px;
      margin-right: 2px;
      border-radius: 2px;
    }

    .axis-title {
      font-size: 0.75rem;
      font-weight: 600;
      margin: 4px 0;
      color: #444;
    }

    .note { font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>

<h1>Vliegtuigen boven Arnhem</h1>

<!-- INTRO -->
<p class="note">Deze pagina toont vluchtgegevens binnen een straal van circa 7,5 km rond Arnhem…</p>

<!-- MAP -->
<div class="section">
  <h2>Het meetgebied boven Arnhem</h2>
  <div id="map"></div>
  <p class="note" id="map-updated"></p>
</div>

<!-- STATS -->
<div class="section">
  <h2>Overzicht van de gemeten vluchten</h2>
  <div id="stats"></div>
</div>

<!-- HEATMAP -->
<div class="section">
  <h2>Wanneer is het druk boven Arnhem?</h2>
  <div class="axis-title">Uur van de dag</div>
  <div id="heatmap"></div>
  <div class="axis-title">Weekdag</div>
</div>

<!-- DAILY CHART -->
<div class="section">
  <h2>Ontwikkeling van het aantal vluchten per dag</h2>
  <canvas id="dailyChart" height="90"></canvas>
</div>

<!-- TOP CALLSIGNS -->
<div class="section">
  <h2>Meest voorkomende callsigns</h2>
  <table id="tbl-top">
    <thead><tr><th>Callsign</th><th>Aantal keer</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- LAST 10 -->
<div class="section">
  <h2>Meest recente vluchten</h2>
  <table id="tbl-last10">
    <thead>
      <tr><th>Tijd</th><th>Callsign</th><th>Snelheid (km/h)</th><th>Hoogte (km)</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- HISTOGRAMS -->
<div class="section">
  <h2>Snelheidsverdeling van unieke vluchten</h2>
  <canvas id="speedHist" height="90"></canvas>
</div>

<div class="section">
  <h2>Hoogteverdeling van unieke vluchten</h2>
  <canvas id="altHist" height="90"></canvas>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const BACKEND = "https://arnhem-flights-api.onrender.com";

/* helpers */
function kts_to_kmh(kts){ return kts ? (kts*1.852).toFixed(1) : ""; }
function ft_to_km(ft){ return ft ? (ft*0.0003048).toFixed(2) : ""; }
function to_amsterdam(iso){
  if (!iso) return "";
  const dt = new Date(iso);
  return dt.toLocaleString("nl-NL",{timeZone:"Europe/Amsterdam",hour12:false}).replace(",","");
}

/* --- MAP --- */
let map, trackLayers = [];

function initMap() {
  map = L.map("map", {
    zoomControl:false, dragging:false, scrollWheelZoom:false,
    doubleClickZoom:false, boxZoom:false, keyboard:false,
    touchZoom:false, tap:false, inertia:false
  }).setView([51.983333,5.916667], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  L.circle([51.983333,5.916667], {
    radius:7500, color:"red", fillColor:"red", fillOpacity:0.05
  }).addTo(map);
}

function clearTracks(){ trackLayers.forEach(l=>l.remove()); trackLayers=[]; }

async function loadTracks(){
  if(!map) initMap();
  clearTracks();
  try{
    const data = await (await fetch(BACKEND+"/api/tracks")).json();
    data.forEach(track=>{
      const pts = track.points.filter(p=>p.lat&&p.lon).map(p=>[p.lat,p.lon]);
      if(pts.length<2) return;
      const poly = L.polyline(pts,{color:"black",weight:2,opacity:0.9});
      poly.addTo(map).bindPopup(track.callsign);
      trackLayers.push(poly);
    });
  }catch{}
}

/* --- STATS --- */
async function loadStats(){
  try{
    const s = await (await fetch(BACKEND+"/api/stats")).json();
    document.getElementById("stats").innerHTML = `
      <p><strong>Totaal aantal vluchten:</strong> ${s.total_flights}</p>
      <p><strong>Eerste meting:</strong> ${to_amsterdam(s.first_ts)}</p>
      <p><strong>Laatste meting:</strong> ${to_amsterdam(s.last_ts)}</p>
      <p><strong>Aantal dagen met data:</strong> ${s.days}</p>
      <p><strong>Mediaan vluchten per dag:</strong> ${s.median_per_day}</p>
      <p><strong>Drukste dag:</strong> ${s.max_per_day_date} (${s.max_per_day} vluchten)</p>`;
  }catch{}
}

/* --- LAST 10 --- */
async function loadLast10(){
  try{
    const data = await (await fetch(BACKEND+"/api/last10")).json();
    const tbody = document.querySelector("#tbl-last10 tbody");
    tbody.innerHTML = data.map(row=>`
      <tr>
        <td>${to_amsterdam(row.ts)}</td>
        <td>${row.callsign}</td>
        <td>${kts_to_kmh(row.gs_kts)}</td>
        <td>${ft_to_km(row.alt_ft)}</td>
      </tr>`).join("");
  }catch{}
}

/* --- TOP CALLSIGNS --- */
async function loadTop(){
  try{
    const data = await (await fetch(BACKEND+"/api/top_callsigns")).json();
    const tbody = document.querySelector("#tbl-top tbody");
    tbody.innerHTML = data.map(r=>`<tr><td>${r.callsign}</td><td>${r.flights}</td></tr>`).join("");
  }catch{}
}

/* --- DAILY CHART --- */
let dailyChart;
async function loadDailyChart(){
  try{
    const data = await (await fetch(BACKEND+"/api/daily_counts")).json();
    const labels = data.map(d=>d.day);
    const values = data.map(d=>d.flights);

    if(dailyChart) dailyChart.destroy();
    dailyChart = new Chart(document.getElementById("dailyChart"),{
      type:"line",
      data:{
        labels,
        datasets:[{
          data:values,
          borderColor:"#444",
          borderWidth:1.2,
          tension:0.1,
          pointRadius:0
        }]
      },
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{ title:{display:true,text:"Datum"} },
          y:{ beginAtZero:true, title:{display:true,text:"Aantal unieke vluchten"} }
        }
      }
    });
  }catch{}
}

/* --- HEATMAP --- */
async function loadHeatmap(){
  try{
    const data = await (await fetch(BACKEND+"/api/hourly_heatmap")).json();
    const grid = Array.from({length:7},()=>Array(24).fill(0));
    let max=0;

    data.forEach(r=>{
      grid[r.dow][r.hour]=r.flights;
      if(r.flights>max) max=r.flights;
    });

    const weekdays=["Zo","Ma","Di","Wo","Do","Vr","Za"];
    const container=document.getElementById("heatmap");
    container.innerHTML="";

    const hourRow=document.createElement("div");
    hourRow.className="heat-row";
    hourRow.innerHTML = `<div class="heat-label"></div>`;
    for(let h=0;h<24;h++){
      hourRow.innerHTML += `<div style="width:16px;text-align:center;font-size:0.7rem;color:#444">${h}</div>`;
    }
    container.appendChild(hourRow);

    for(let d=0;d<7;d++){
      const row=document.createElement("div");
      row.className="heat-row";
      row.innerHTML = `<div class="heat-label">${weekdays[d]}</div>`;
      for(let h=0;h<24;h++){
        const v=grid[d][h];
        let col="transparent";
        if(v>0){
          const t=v/max;
          col=`rgb(${Math.round(255*t)},0,${Math.round(255*(1-t))})`;
        }
        row.innerHTML += `<div class="heat-cell" style="background:${col}" title="${weekdays[d]} ${h}:00 — ${v} vluchten"></div>`;
      }
      container.appendChild(row);
    }
  }catch{}
}

/* --- SPEED HISTOGRAM --- */
let speedChart;
async function loadSpeedHist(){
  try{
    const raw=await (await fetch(BACKEND+"/api/hist_speed")).json();
    const kmh=raw.map(v=>v*1.852).filter(v=>v>0);

    const buckets = Array(11).fill(0);
    kmh.forEach(v=>{
      if(v>=1000) buckets[10]++;
      else buckets[Math.floor(v/100)]++;
    });

    const labels=["0–100","100–200","200–300","300–400","400–500","500–600","600–700","700–800","800–900","900–1000","1000+"];

    if(speedChart) speedChart.destroy();
    speedChart = new Chart(document.getElementById("speedHist"),{
      type:"bar",
      data:{ labels, datasets:[{ data:buckets, backgroundColor:"#777" }]},
      options:{
        plugins:{ legend:{display:false}},
        scales:{
          x:{ title:{display:true,text:"Snelheid (km/h)"} },
          y:{ beginAtZero:true, title:{display:true,text:"Aantal observaties"} }
        }
      }
    });
  }catch{}
}

/* --- ALTITUDE HISTOGRAM --- */
let altChart;
async function loadAltHist(){
  try{
    const raw=await (await fetch(BACKEND+"/api/hist_altitude")).json();
    const km = raw.map(v=>v*0.0003048).filter(v=>v>0);

    const buckets=Array(15).fill(0);
    km.forEach(v=> v>=14 ? buckets[14]++ : buckets[Math.floor(v)]++);

    const labels=["0–1","1–2","2–3","3–4","4–5","5–6","6–7","7–8","8–9","9–10","10–11","11–12","12–13","13–14","14+"];

    if(altChart) altChart.destroy();
    altChart = new Chart(document.getElementById("altHist"),{
      type:"bar",
      data:{ labels, datasets:[{ data:buckets, backgroundColor:"#777" }]},
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{ title:{display:true,text:"Hoogte (km)"} },
          y:{ beginAtZero:true, title:{display:true,text:"Aantal observaties"} }
        }
      }
    });
  }catch{}
}

/* MAP TIMESTAMP */
async function updateMapTimestamp(){
  try{
    const data = await (await fetch(BACKEND+"/api/last10")).json();
    if(data.length>0){
      document.getElementById("map-updated").textContent =
        "Laatste update: "+to_amsterdam(data[0].ts);
    }
  }catch{}
}

/* INIT */
loadStats();
loadHeatmap();
loadDailyChart();
loadTop();
loadLast10();
loadTracks();
loadSpeedHist();
loadAltHist();
updateMapTimestamp();

/* periodic refresh */
setInterval(loadLast10,60000);
setInterval(loadTracks,120000);
setInterval(loadDailyChart,300000);
setInterval(loadTop,300000);
setInterval(updateMapTimestamp,60000);
setInterval(loadSpeedHist,300000);
setInterval(loadAltHist,300000);
</script>

</body>
</html>
