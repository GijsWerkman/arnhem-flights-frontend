<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Vliegtuig herrie boven Arnhem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root {
      --bg: #ffffff;
      --fg: #111;
      --border: #ddd;
      --link: #064CBD;
    }
    body.dark {
      --bg: #0d1117;
      --fg: #d1d5db;
      --border: #2f3339;
      --link: #7aa2f7;
    }

    body {
      font-family: system-ui, sans-serif;
      margin: auto;
      padding: 1.5rem;
      max-width: 900px;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      transition: background .2s, color .2s;
    }
    h1, h2 {
      margin-top: 2.4rem;
      margin-bottom: .6rem;
      font-weight: 600;
    }
    h1 { font-size: 1.9rem; }
    h2 { font-size: 1.4rem; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: .7rem;
      font-size: .95rem;
    }
    th, td {
      padding: .4rem .5rem;
      border: 1px solid var(--border);
    }
    th {
      background: rgba(0,0,0,0.05);
      text-align: left;
    }

    a { color: var(--link); }

    #map {
      width: 100%;
      height: 350px;
      border: 1px solid var(--border);
      margin-top: .8rem;
      border-radius: .4rem;
    }

    .toggle {
      float: right;
      padding: .35rem .7rem;
      font-size: .85rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: none;
      cursor: pointer;
    }

    .section {
      border-top: 1px solid var(--border);
      margin-top: 2rem;
      padding-top: 1.5rem;
    }

    .stats-grid {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-top: .5rem;
    }
    .stat {
      min-width: 140px;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 600;
    }
    .stat-label {
      font-size: .85rem;
      opacity: .75;
    }

    #heatmap {
      margin-top: .8rem;
      font-size: .75rem;
    }
    .heat-row { display: flex; }
    .cell {
      width: 18px;
      height: 18px;
      margin: 1px;
      line-height: 18px;
      font-size: 10px;
      text-align: center;
      border-radius: 2px;
      background: transparent;
    }
    .cell-label {
      width: 24px;
      margin-right: .4rem;
    }
  </style>
</head>

<body>

<button class="toggle" id="darkToggle">ðŸŒ™ Donkere modus</button>

<h1>Vliegtuigen boven Arnhem</h1>
<p>
  Deze pagina toont vliegbewegingen binnen Â±5 km rond Arnhem.<br/>
  Gegevens afkomstig van
  <a href="https://adsb.fi" target="_blank">adsb.fi</a>,
  privÃ© & niet-commercieel gebruik.
</p>

<!-- =============================== -->
<!-- Overzicht cijfers -->
<!-- =============================== -->
<div class="section">
  <h2>Overzicht</h2>

  <div class="stats-grid">
    <div class="stat">
      <div class="stat-value" id="stat-total">â€“</div>
      <div class="stat-label">Totaal vluchten</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-median">â€“</div>
      <div class="stat-label">Mediaan per dag</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-busiest">â€“</div>
      <div class="stat-label">Drukste dag</div>
    </div>
  </div>

  <p style="margin-top:.7rem;font-size:.9rem;">
    Periode: <span id="stat-range">â€“</span>
  </p>
</div>

<!-- =============================== -->
<!-- Laatste 10 -->
<!-- =============================== -->
<div class="section">
  <h2>Laatste 10 vliegtuigen</h2>

  <table>
    <thead>
      <tr>
        <th>Tijd (UTC)</th>
        <th>Callsign</th>
        <th>Snelheid (km/h)</th>
        <th>Hoogte (km)</th>
      </tr>
    </thead>
    <tbody id="last10-body"></tbody>
  </table>
</div>

<!-- =============================== -->
<!-- Dag-totalen -->
<!-- =============================== -->
<div class="section">
  <h2>Aantal vluchten per dag</h2>
  <canvas id="dailyChart" height="140"></canvas>
</div>

<!-- =============================== -->
<!-- Heatmap -->
<!-- =============================== -->
<div class="section">
  <h2>Drukte per uur (gemiddeld)</h2>
  <div id="heatmap"></div>
</div>

<!-- =============================== -->
<!-- Top 10 callsigns -->
<!-- =============================== -->
<div class="section">
  <h2>Top 10 callsigns</h2>
  <table>
    <thead>
      <tr>
        <th>Callsign</th>
        <th>Aantal</th>
      </tr>
    </thead>
    <tbody id="topcallsigns"></tbody>
  </table>
</div>

<!-- =============================== -->
<!-- Tracks -->
<!-- =============================== -->
<div class="section">
  <h2>Laatste vliegroutes</h2>
  <div id="map"></div>
</div>

<!-- =============================== -->
<!-- Leaflet, Chart.js -->
<!-- =============================== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const BACKEND = "https://arnhem-flights-api.onrender.com";

/* ---------- helpers ---------- */
function kts_to_kmh(kts){ return kts ? (kts * 1.852).toFixed(1) : "" }
function ft_to_km(ft){ return ft ? (ft * 0.0003048).toFixed(2) : "" }
function fmtDate(iso){ return iso ? iso.slice(0,10) : "â€“" }

/* ---------- dark mode ---------- */
document.getElementById("darkToggle").onclick = () =>
  document.body.classList.toggle("dark");

/* ---------- last10 ---------- */
async function loadLast10(){
  const r = await fetch(`${BACKEND}/api/last10`);
  const data = await r.json();
  const tb = document.getElementById("last10-body");
  tb.innerHTML = "";
  data.forEach(row=>{
    tb.innerHTML += `
      <tr>
        <td>${row.ts}</td>
        <td>${row.callsign}</td>
        <td>${kts_to_kmh(row.gs_kts)}</td>
        <td>${ft_to_km(row.alt_ft)}</td>
      </tr>`;
  });
}

/* ---------- stats ---------- */
async function loadStats(){
  const r = await fetch(`${BACKEND}/api/stats`);
  const s = await r.json();
  document.getElementById("stat-total").textContent = s.total_flights;
  document.getElementById("stat-median").textContent = s.median_per_day;
  document.getElementById("stat-busiest").textContent =
    s.max_per_day ? `${s.max_per_day} (${s.max_per_day_date})` : "â€“";
  document.getElementById("stat-range").textContent =
    `${fmtDate(s.first_ts)} â€“ ${fmtDate(s.last_ts)}`;
}

/* ---------- daily chart ---------- */
let chart;
async function loadDaily(){
  const r = await fetch(`${BACKEND}/api/daily_counts`);
  const d = await r.json();
  const ctx = document.getElementById("dailyChart");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels:d.map(x=>x.day),
      datasets:[{data:d.map(x=>x.flights)}]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

/* ---------- top callsigns ---------- */
async function loadTop(){
  const r = await fetch(`${BACKEND}/api/top_callsigns`);
  const d = await r.json();
  const tb = document.getElementById("topcallsigns");
  tb.innerHTML = "";
  d.forEach(x=>{
    tb.innerHTML += `<tr><td>${x.callsign}</td><td>${x.flights}</td></tr>`;
  });
}

/* ---------- heatmap ---------- */
async function loadHeatmap(){
  const r = await fetch(`${BACKEND}/api/hourly_heatmap`);
  const d = await r.json();
  
  const max = Math.max(...d.map(x => x.flights), 1);
  const weekdays = ["Zo","Ma","Di","Wo","Do","Vr","Za"];
  const map = document.getElementById("heatmap");
  map.innerHTML = "";

  for(let dow=0;dow<7;dow++){
    const row = document.createElement("div");
    row.className = "heat-row";

    const label = document.createElement("div");
    label.textContent = weekdays[dow];
    label.className = "cell-label";
    row.appendChild(label);

    for(let h=0;h<24;h++){
      const rec = d.find(x => x.dow===dow && x.hour===h);
      const v = rec ? rec.flights : 0;
      const t = v/max;
      const c = v? `rgba(8, 48, 107, ${0.3 + 0.7*t})` : "transparent";

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.style.background = c;
      cell.title = `${weekdays[dow]} ${h}:00 â€” ${v} vluchten`;
      row.appendChild(cell);
    }
    map.appendChild(row);
  }
}

/* ---------- map & tracks ---------- */
let Lmap;
let layers = [];

function initMap(){
  Lmap = L.map("map").setView([51.9851,5.8987],11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(Lmap);
}

async function loadTracks(){
  if(!Lmap) initMap();
  layers.forEach(l=>l.remove());
  layers = [];

  const r = await fetch(`${BACKEND}/api/tracks`);
  const tracks = await r.json();

  tracks.forEach((tr,i)=>{
    const pts = tr.points.map(p=>[p.lat,p.lon]);
    if(pts.length<2) return;
    const col = ["#d33","#36f","#3c3","#eaa","#a3f","#f3a","#0bb","#fa0","#099","#444"][i%10];
    const line = L.polyline(pts,{color:col,weight:2}).addTo(Lmap);
    line.bindPopup(tr.callsign);
    layers.push(line);
  });

  const all = layers.flatMap(l=>l.getLatLngs());
  if(all.length) Lmap.fitBounds(all,{padding:[20,20]});
}

/* ---------- init ---------- */
loadLast10();
loadStats();
loadDaily();
loadTop();
loadHeatmap();
loadTracks();

setInterval(loadLast10,60000);
setInterval(loadTracks,120000);
</script>

</body>
</html>
