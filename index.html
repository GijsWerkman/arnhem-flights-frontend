<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Vliegtuigen boven Arnhem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts à la RMarkdown -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&family=Roboto+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Source Serif Pro", serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem 3rem;
      line-height: 1.6;
      color: #222;
      background: #fafafa;
    }

    h1, h2, h3 {
      font-weight: 600;
      margin-top: 2.2rem;
      margin-bottom: 1rem;
    }

    h1 { font-size: 2.1rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.2rem; }

    p { margin: 0.6rem 0; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.6rem;
      font-family: "Roboto Mono", monospace;
      font-size: 0.9rem;
      background: #fff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.5rem;
    }

    th {
      background: #f3f3f3;
      font-weight: 600;
    }

    .section {
      margin-top: 2rem;
      margin-bottom: 2.5rem;
      border-top: 1px solid #ddd;
      padding-top: 1.2rem;
    }

    #map {
      width: 100%;
      height: 350px;
      border: 1px solid #ccc;
      margin-top: 0.7rem;
    }

    /* Heatmap grid */
    #heatmap {
      margin-top: 0.7rem;
      font-size: 0.8rem;
      transform: scale(1.25);
      transform-origin: left top;
    }

    .heat-row {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .heat-label {
      width: 26px;
      text-align: right;
      margin-right: 4px;
      color: #555;
    }
    .heat-cell {
      width: 16px;
      height: 16px;
      margin-right: 2px;
      border-radius: 2px;
      background: transparent;
    }

    .note {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>

<h1>Vliegtuigen boven Arnhem</h1>
<p class="note">
  Deze pagina toont vluchtgegevens binnen een straal van circa 7,5 km rond Arnhem.
  De gegevens zijn afkomstig van <a href="https://adsb.fi" target="_blank">adsb.fi open data</a>
  en worden uitsluitend voor persoonlijk, niet-commercieel gebruik ingezet.
</p>
<p class="note">
  Met deze metingen wordt zichtbaar hoe vaak en wanneer er toestellen overkomen,
  welke routes worden gevlogen en welke vluchten structureel boven Arnhem plaatsvinden.
</p>

<!-- 1. Kaart en meetgebied -->
<div class="section">
  <h2>Het meetgebied boven Arnhem</h2>
  <p class="note">
    De rode cirkel geeft het gebied weer waarbinnen vluchten worden geregistreerd.
    De zwarte lijnen tonen de meest recente vluchten.
  </p>
  <div id="map"></div>
  <p class="note" id="map-updated"></p>
</div>

<!-- 2. Statistieken -->
<div class="section">
  <h2>Overzicht van de gemeten vluchten</h2>
  <p class="note">
    Dit overzicht vat de huidige dataset samen qua aantallen vluchten,
    duur van de meetperiode en dagelijkse drukte.
  </p>
  <div id="stats"></div>
</div>

<!-- 3. Uurlijkse drukte -->
<div class="section">
  <h2>Wanneer is het druk boven Arnhem?</h2>
  <p class="note">
    De onderstaande matrix laat per weekdag en uur zien hoe vaak er gemiddeld vluchten
    in het meetgebied worden geregistreerd. Donkere vakken duiden op relatief drukke momenten.
  </p>
  <div id="heatmap"></div>
</div>

<!-- 4. Vluchten per dag -->
<div class="section">
  <h2>Ontwikkeling van het aantal vluchten per dag</h2>
  <p class="note">
    Deze tijdreeks toont hoe het aantal vluchten per dag door de tijd heen varieert.
    Pieken en dalen kunnen samenhangen met vakantieperiodes, weersomstandigheden of
    wijzigingen in luchtverkeersroutes.
  </p>
  <canvas id="dailyChart" height="90"></canvas>
</div>

<!-- 5. Top callsigns -->
<div class="section">
  <h2>Meest voorkomende callsigns</h2>
  <p class="note">
    Sommige vluchten komen frequent terug boven Arnhem. Onderstaande tabel toont de
    callsigns welke het vaakst in het meetgebied geregistreerd zijn.
  </p>
  <table id="tbl-top">
    <thead>
      <tr><th>Callsign</th><th>Aantal keer</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 6. Meest recente vluchten -->
<div class="section">
  <h2>Meest recente vluchten</h2>
  <p class="note">
    Deze tabel geeft de meest recente vluchten weer, waarbij per combinatie van
    callsign slechts de laatste meting wordt getoond.
  </p>
  <table id="tbl-last10">
    <thead>
      <tr>
        <th>Tijd</th>
        <th>Callsign</th>
        <th>Snelheid (km/h)</th>
        <th>Hoogte (km)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 7. Histogram snelheden -->
<div class="section">
  <h2>Snelheidsverdeling van vluchten</h2>
  <p class="note">
    Dit histogram toont de verdeling van grondsnelheden van vluchten binnen het meetgebied.
  </p>
  <canvas id="speedHist" height="90"></canvas>
</div>

<!-- 8. Histogram hoogten -->
<div class="section">
  <h2>Hoogteverdeling van vluchten</h2>
  <p class="note">
    Dit histogram laat zien op welke hoogtes toestellen doorgaans over Arnhem vliegen.
  </p>
  <canvas id="altHist" height="90"></canvas>
</div>

<!-- 9. Scatterplot snelheid vs hoogte -->
<div class="section">
  <h2>Relatie tussen snelheid en hoogte</h2>
  <p class="note">
    Deze scatterplot toont per vlucht de combinatie van grondsnelheid en hoogte.
  </p>

  <!-- ⭐ UPDATED: much higher and aspect-ratio disabled ⭐ -->
  <canvas id="scatterSpeedAlt" style="height: 350px; width: 100%;"></canvas>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const BACKEND = "https://arnhem-flights-api.onrender.com";

/* Helpers */
function kts_to_kmh(kts) { return kts ? (kts * 1.852).toFixed(1) : ""; }
function ft_to_km(ft) { return ft ? (ft * 0.0003048).toFixed(2) : ""; }
function to_amsterdam(iso) {
  if (!iso) return "";
  const dt = new Date(iso);
  return dt.toLocaleString("nl-NL", { timeZone: "Europe/Amsterdam", hour12: false }).replace(",", "");
}

/* ---- kaart timestamp ---- */
async function updateMapTimestamp() {
  try {
    const r = await fetch(BACKEND + "/api/last10");
    const data = await r.json();
    if (!data || data.length === 0) return;
    document.getElementById("map-updated").textContent =
      `Laatste update: ${to_amsterdam(data[0].ts)}`;
  } catch {}
}

/* ... (rest van jouw code blijft onveranderd tot scatter-plot) ... */

/* scatter speed vs altitude */
let scatterChart;
async function loadScatter() {
  try {
    const r = await fetch(BACKEND + "/api/scatter");
    const data = await r.json();

    const points = data
      .filter(d => d.gs_kts != null && d.alt_ft != null)
      .map(d => ({
        x: d.gs_kts * 1.852,
        y: d.alt_ft * 0.0003048
      }))
      .filter(p => p.x >= 0 && p.x <= 1000 && p.y >= 0 && p.y <= 14);

    const ctx = document.getElementById("scatterSpeedAlt");
    if (scatterChart) scatterChart.destroy();

    scatterChart = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [{
          data: points,
          pointRadius: 2,
          backgroundColor: "rgba(0,0,0,0.7)"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // ⭐ belangrijk voor vaste canvas-hoogte ⭐
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            min: 0, max: 1000,
            ticks: { stepSize: 100 },
            title: { display: true, text: "Snelheid (km/h)" }
          },
          y: {
            min: 0, max: 14,
            ticks: { stepSize: 1 },
            title: { display: true, text: "Hoogte (km)" }
          }
        }
      }
    });
  } catch (e) {
    console.error("scatter error", e);
  }
}

/* Map & tracks + init calls ... unchanged */
loadStats();
loadHeatmap();
loadDailyChart();
loadTop();
loadLast10();
loadTracks();
loadSpeedHist();
loadAltHist();
loadScatter();
updateMapTimestamp();

setInterval(loadLast10, 60000);
setInterval(loadTracks, 120000);
setInterval(loadDailyChart, 300000);
setInterval(loadTop, 300000);
setInterval(updateMapTimestamp, 60000);
setInterval(loadSpeedHist, 300000);
setInterval(loadAltHist, 300000);
setInterval(loadScatter, 300000);
</script>

</body>
</html>
