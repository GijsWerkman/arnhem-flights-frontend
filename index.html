<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Vliegtuigen boven Arnhem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts à la RMarkdown -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&family=Roboto+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Source Serif Pro", serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem 3rem;
      line-height: 1.6;
      color: #222;
      background: #fafafa;
    }

    h1, h2, h3 {
      font-weight: 600;
      margin-top: 2.2rem;
      margin-bottom: 1rem;
    }

    h1 { font-size: 2.1rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.2rem; }

    p { margin: 0.6rem 0; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.6rem;
      font-family: "Roboto Mono", monospace;
      font-size: 0.9rem;
      background: #fff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.5rem;
    }

    th {
      background: #f3f3f3;
      font-weight: 600;
    }

    .section {
      margin-top: 2rem;
      margin-bottom: 2.5rem;
      border-top: 1px solid #ddd;
      padding-top: 1.2rem;
    }

    #map {
      width: 100%;
      height: 350px;
      border: 1px solid #ccc;
      margin-top: 0.7rem;
    }

    /* Heatmap grid */
    #heatmap {
      margin-top: 0.7rem;
      font-size: 0.8rem;
    }
    .heat-row {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .heat-label {
      width: 26px;
      text-align: right;
      margin-right: 4px;
      color: #555;
    }
    .heat-cell {
      width: 16px;
      height: 16px;
      margin-right: 2px;
      border-radius: 2px;
      background: transparent;
    }

    .note {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>

<h1>Vliegtuigen boven Arnhem</h1>
<p class="note">
  Deze pagina toont vluchtgegevens binnen een straal van circa 7,5 km rond Arnhem.
  De gegevens zijn afkomstig van <a href="https://adsb.fi" target="_blank">adsb.fi open data</a>
  en worden uitsluitend voor persoonlijk, niet-commercieel gebruik ingezet.
</p>
<p class="note">
  Met deze metingen wordt zichtbaar hoe vaak en wanneer er toestellen overkomen,
  welke routes worden gevlogen en welke vluchten structureel boven Arnhem plaatsvinden.
</p>

<!-- 1. Kaart en meetgebied -->
<div class="section">
  <h2>Het meetgebied boven Arnhem</h2>
  <p class="note">
    De rode cirkel geeft het gebied weer waarbinnen vluchten worden geregistreerd.
    De zwarte lijnen tonen de meest recente vluchten.
  </p>
  <div id="map"></div>
</div>

<!-- 2. Statistieken -->
<div class="section">
  <h2>Overzicht van de gemeten vluchten</h2>
  <p class="note">
    Dit overzicht vat de huidige dataset samen qua aantallen vluchten,
    duur van de meetperiode en dagelijkse drukte.
  </p>
  <div id="stats"></div>
</div>

<!-- 3. Uurlijkse drukte -->
<div class="section">
  <h2>Wanneer is het druk boven Arnhem?</h2>
  <p class="note">
    De onderstaande matrix laat per weekdag en uur zien hoe vaak er gemiddeld vluchten
    in het meetgebied worden geregistreerd. Donkere vakken duiden op relatief drukke momenten.
  </p>
  <div id="heatmap"></div>
</div>

<!-- 4. Vluchten per dag -->
<div class="section">
  <h2>Ontwikkeling van het aantal vluchten per dag</h2>
  <p class="note">
    Deze tijdreeks toont hoe het aantal vluchten per dag door de tijd heen varieert.
    Pieken en dalen kunnen samenhangen met vakantieperiodes, weersomstandigheden of
    wijzigingen in luchtverkeersroutes.
  </p>
  <canvas id="dailyChart" height="90"></canvas>
</div>

<!-- 5. Top callsigns -->
<div class="section">
  <h2>Meest voorkomende callsigns</h2>
  <p class="note">
    Sommige vluchten komen frequent terug boven Arnhem. Onderstaande tabel toont de
    callsigns welke het vaakst in het meetgebied geregistreerd zijn.
  </p>
  <table id="tbl-top">
    <thead>
      <tr>
        <th>Callsign</th>
        <th>Aantal uren</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 6. Meest recente vluchten -->
<div class="section">
  <h2>Meest recente vluchten</h2>
  <p class="note">
    Deze tabel geeft de meest recente vluchten weer, waarbij per combinatie van
    callsign slechts de laatste meting wordt getoond.
  </p>
  <table id="tbl-last10">
    <thead>
      <tr>
        <th>Tijd</th>
        <th>Callsign</th>
        <th>Snelheid (km/h)</th>
        <th>Hoogte (km)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const BACKEND = "https://arnhem-flights-api.onrender.com";

/* Helpers */
function kts_to_kmh(kts) {
  return kts ? (kts * 1.852).toFixed(1) : "";
}
function ft_to_km(ft) {
  return ft ? (ft * 0.0003048).toFixed(2) : "";
}
function to_amsterdam(iso) {
  if (!iso) return "";
  const dt = new Date(iso);
  return dt.toLocaleString("nl-NL", {
    timeZone: "Europe/Amsterdam",
    hour12: false
  }).replace(",", "");
}

/* 1. Last 10 flights */
async function loadLast10() {
  try {
    const r = await fetch(BACKEND + "/api/last10");
    const data = await r.json();
    const tbody = document.querySelector("#tbl-last10 tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${to_amsterdam(row.ts)}</td>
        <td>${row.callsign}</td>
        <td>${kts_to_kmh(row.gs_kts)}</td>
        <td>${ft_to_km(row.alt_ft)}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error("last10 error", e);
  }
}

/* 2. Stats */
async function loadStats() {
  try {
    const r = await fetch(BACKEND + "/api/stats");
    const s = await r.json();
    const el = document.getElementById("stats");
    el.innerHTML = `
      <p><strong>Totaal aantal vluchten:</strong> ${s.total_flights}</p>
      <p><strong>Eerste meting:</strong> ${to_amsterdam(s.first_ts)}</p>
      <p><strong>Laatste meting:</strong> ${to_amsterdam(s.last_ts)}</p>
      <p><strong>Aantal dagen met data:</strong> ${s.days}</p>
      <p><strong>Mediaan vluchten per dag:</strong> ${s.median_per_day}</p>
      <p><strong>Drukste dag:</strong> ${
        s.max_per_day_date ? s.max_per_day_date + " (" + s.max_per_day + " vluchten)" : "–"
      }</p>
    `;
  } catch (e) {
    console.error("stats error", e);
  }
}

/* 3. Daily chart */
let dailyChart;
async function loadDailyChart() {
  try {
    const r = await fetch(BACKEND + "/api/daily_counts");
    const data = await r.json();
    const labels = data.map(d => d.day);
    const values = data.map(d => d.flights);

    const ctx = document.getElementById("dailyChart");
    if (dailyChart) dailyChart.destroy();
    dailyChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: values,
          borderColor: "#444",
          borderWidth: 1.2,
          tension: 0.1,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxTicksLimit: 10 } },
          y: { beginAtZero: true }
        }
      }
    });
  } catch (e) {
    console.error("daily chart error", e);
  }
}

/* 4. Heatmap (simple div grid) */
async function loadHeatmap() {
  try {
    const r = await fetch(BACKEND + "/api/hourly_heatmap");
    const data = await r.json();

    // Build matrix: dow 0–6, hour 0–23
    const grid = Array.from({length:7},()=>Array(24).fill(0));
    let max = 0;
    data.forEach(row => {
      const d = row.dow;
      const h = row.hour;
      const v = row.flights;
      grid[d][h] = v;
      if (v > max) max = v;
    });

    const weekdays = ["Zo","Ma","Di","Wo","Do","Vr","Za"];
    const container = document.getElementById("heatmap");
    container.innerHTML = "";

    // ---- X-as labels (uren) ----
    const hourRow = document.createElement("div");
    hourRow.className = "heat-row";
    const spacer = document.createElement("div");
    spacer.className = "heat-label";
    hourRow.appendChild(spacer);

    for (let h = 0; h < 24; h++) {
      const lbl = document.createElement("div");
      lbl.style.width = "16px";
      lbl.style.textAlign = "center";
      lbl.style.fontSize = "0.7rem";
      lbl.style.color = "#444";
      lbl.textContent = h;
      hourRow.appendChild(lbl);
    }
    container.appendChild(hourRow);

    // ---- Heatmap zelf ----
    for (let dow = 0; dow < 7; dow++) {
      const rowDiv = document.createElement("div");
      rowDiv.className = "heat-row";

      const label = document.createElement("div");
      label.className = "heat-label";
      label.textContent = weekdays[dow];
      rowDiv.appendChild(label);

      for (let h = 0; h < 24; h++) {
        const v = grid[dow][h];
        const cell = document.createElement("div");
        cell.className = "heat-cell";

        if (max > 0 && v > 0) {
          // t = intensiteit 0–1
          const t = v / max;

          // blauw → rood overgang (linear interpolation)
          const r_val = Math.round(255 * t);
          const g_val = 0;
          const b_val = Math.round(255 * (1 - t));

          cell.style.backgroundColor = `rgb(${r_val},${g_val},${b_val})`;
        } else {
          cell.style.backgroundColor = "transparent";
        }
        cell.title = `${weekdays[dow]} ${h}:00 — ${v} vluchten`;
        rowDiv.appendChild(cell);
      }
      container.appendChild(rowDiv);
    }
  } catch (e) {
    console.error("heatmap error", e);
  }
}


/* 5. Top callsigns */
async function loadTop() {
  try {
    const r = await fetch(BACKEND + "/api/top_callsigns");
    const data = await r.json();
    const tbody = document.querySelector("#tbl-top tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${row.callsign}</td><td>${row.flights}</td>`;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error("top callsigns error", e);
  }
}

/* 6. Map + tracks */
let map;
let trackLayers = [];

function initMap() {
  const center = [51.983333, 5.916667]; // Arnhem

  map = L.map("map", {
    zoomControl: false,
    dragging: false,
    scrollWheelZoom: false,
    doubleClickZoom: false,
    boxZoom: false,
    keyboard: false,
    touchZoom: false,
    tap: false,
    inertia: false
  }).setView(center, 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap-bijdragers"
  }).addTo(map);

  // Rode radius van 7,5 km
  L.circle(center, {
    radius: 7500,
    color: "red",
    weight: 2,
    fillColor: "red",
    fillOpacity: 0.05
  }).addTo(map);
}

function clearTracks() {
  trackLayers.forEach(l => l.remove());
  trackLayers = [];
}

async function loadTracks() {
  try {
    if (!map) initMap();
    const r = await fetch(BACKEND + "/api/tracks");
    const data = await r.json();

    clearTracks();

    data.forEach(track => {
      const pts = track.points
        .filter(p => p.lat != null && p.lon != null)
        .map(p => [p.lat, p.lon]);

      if (pts.length < 2) return;

      const poly = L.polyline(pts, {
        color: "black",
        weight: 2,
        opacity: 0.9
      });
      poly.addTo(map).bindPopup(track.callsign);
      trackLayers.push(poly);
    });
  } catch (e) {
    console.error("tracks error", e);
  }
}

/* Init */
loadStats();
loadHeatmap();
loadDailyChart();
loadTop();
loadLast10();
loadTracks();

setInterval(loadLast10, 60000);
setInterval(loadTracks, 120000);
setInterval(loadDailyChart, 300000);
setInterval(loadTop, 300000);
</script>

</body>
</html>
